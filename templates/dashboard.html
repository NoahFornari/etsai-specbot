{% extends "_base.html" %}

{% block title %}Dashboard — ETSAI{% endblock %}

{% block extra_styles %}
    .welcome-banner {
        background: linear-gradient(135deg, rgba(74,103,65,0.06) 0%, rgba(217,119,6,0.04) 100%);
        border: 1px solid rgba(74,103,65,0.12);
        border-radius: 0;
        padding: 1.5rem;
        clip-path: polygon(14px 0%, calc(100% - 14px) 0%, 100% 14px, 100% calc(100% - 14px), calc(100% - 14px) 100%, 14px 100%, 0% calc(100% - 14px), 0% 14px);
    }
    html.dark .welcome-banner {
        background: linear-gradient(135deg, rgba(107,148,96,0.08) 0%, rgba(245,158,11,0.04) 100%);
        border-color: rgba(107,148,96,0.15);
    }
    .quick-action {
        padding: 0.75rem 1.25rem; border-radius: 12px; font-size: 0.875rem;
        font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        display: inline-flex; align-items: center; gap: 0.5rem;
        text-decoration: none;
    }
    .activity-dot {
        width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .activity-line {
        width: 2px; background: var(--border-default); margin-left: 3px;
        min-height: 20px; flex-shrink: 0;
    }
    .product-thumb {
        width: 36px; height: 36px; border-radius: 10px; object-fit: cover; flex-shrink: 0;
    }
    .product-initial {
        width: 36px; height: 36px; border-radius: 10px; display: flex;
        align-items: center; justify-content: center; font-weight: 700;
        font-size: 0.875rem; color: white; flex-shrink: 0;
        background: linear-gradient(135deg, #4a6741, #5c7d52);
    }
    .mini-progress {
        height: 3px; border-radius: 2px; background: var(--surface-3); overflow: hidden;
    }
    .mini-progress-fill {
        height: 100%; border-radius: 2px;
        background: linear-gradient(90deg, #4a6741, #5c7d52);
        transition: width 0.3s ease;
    }
    .filter-pill {
        padding: 0.5rem 0.875rem; border-radius: 9999px; font-size: 0.75rem;
        font-weight: 600; cursor: pointer; transition: all 0.2s;
        border: 1px solid var(--border-default); background: var(--surface-0);
        color: var(--text-tertiary);
    }
    .filter-pill:hover { border-color: var(--brand); color: var(--brand); }
    .filter-pill.active {
        background: var(--brand-bg); border-color: var(--brand);
        color: var(--brand);
    }
    .badge-danger { background: rgba(220,38,38,0.1); color: #dc2626; }
    html.dark .badge-danger { background: rgba(220,38,38,0.15); color: #f87171; }
    .badge-stale { background: var(--amber-bg); color: var(--amber); }
    .spec-chevron.open { transform: rotate(180deg); }
{% endblock %}

{% block body %}
    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="p-5 pb-3">
            <a href="/dashboard" class="flex items-center gap-1.5 text-xl font-extrabold tracking-tight no-underline" style="color: var(--text-primary);"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none"><ellipse cx="12" cy="22" rx="9" ry="5" transform="rotate(-25 12 22)" fill="#5c7d52"/><ellipse cx="20" cy="27" rx="10" ry="7" fill="#4a6741"/><ellipse cx="23" cy="29" rx="7" ry="5" fill="#f4845f"/><circle cx="27" cy="15" r="9" fill="#4a6741"/><path d="M35 13L48 11.5L35 16.5Z" fill="#d4846a"/><circle cx="31" cy="13" r="3" fill="white"/><circle cx="32" cy="13" r="1.8" fill="#2c1810"/><circle cx="32.5" cy="12" r="0.7" fill="white"/><path d="M8 31L3 38L7 34L4 41L9 33" fill="#3d5a37"/></svg><span>ETS<span class="gradient-text">AI</span></span></a>
        </div>

        <nav class="flex-1 py-2">
            <a href="/dashboard" class="sidebar-nav-item active">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"/></svg>
                Dashboard
            </a>
            <a href="/products/add" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Products
            </a>
            {% if seller.etsy_access_token %}
            <a href="/dashboard#etsy" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>
                Etsy
            </a>
            {% endif %}
            <a href="/settings" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Settings
            </a>
        </nav>

        <div class="p-4 border-t" style="border-color: var(--border-default);">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold text-white" style="background: linear-gradient(135deg, #4a6741, #5c7d52);">{{ (seller.shop_name or 'S')[0] }}</div>
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium truncate" style="color: var(--text-primary);">{{ seller.shop_name or 'My Shop' }}</p>
                    <p class="text-xs truncate" style="color: var(--text-tertiary);">{{ seller.email }}</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <button onclick="toggleDarkMode()" class="p-1.5 rounded-lg transition-colors" style="color: var(--text-tertiary);" aria-label="Toggle dark mode">
                    <svg class="w-4 h-4 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    <svg class="w-4 h-4 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                </button>
                <a href="/logout" class="text-xs font-medium no-underline transition-colors" style="color: var(--text-tertiary);" onmouseover="this.style.color='var(--brand)'" onmouseout="this.style.color='var(--text-tertiary)'">Log out</a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile header -->
        <div class="md:hidden sticky top-0 z-30 border-b px-4 h-14 flex items-center gap-3" style="background: var(--surface-0); border-color: var(--border-default);">
            <button onclick="toggleSidebar()" class="p-1.5" style="color: var(--text-secondary);">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
            </button>
            <span class="flex items-center gap-1 text-lg font-extrabold" style="color: var(--text-primary);"><svg class="w-5 h-5" viewBox="0 0 48 48" fill="none"><ellipse cx="12" cy="22" rx="9" ry="5" transform="rotate(-25 12 22)" fill="#5c7d52"/><ellipse cx="20" cy="27" rx="10" ry="7" fill="#4a6741"/><ellipse cx="23" cy="29" rx="7" ry="5" fill="#f4845f"/><circle cx="27" cy="15" r="9" fill="#4a6741"/><path d="M35 13L48 11.5L35 16.5Z" fill="#d4846a"/><circle cx="31" cy="13" r="3" fill="white"/><circle cx="32" cy="13" r="1.8" fill="#2c1810"/><circle cx="32.5" cy="12" r="0.7" fill="white"/><path d="M8 31L3 38L7 34L4 41L9 33" fill="#3d5a37"/></svg><span>ETS<span class="gradient-text">AI</span></span></span>
        </div>

        <div class="max-w-5xl mx-auto px-6 py-8">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            {% endwith %}

            <!-- Welcome Banner -->
            <div class="welcome-banner mb-6 animate-in">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h1 class="text-xl font-semibold mb-1" style="color: var(--text-primary);" id="greeting">Good morning, {{ seller.display_name or seller.shop_name }}!</h1>
                        <p class="text-sm italic" style="color: var(--text-secondary);" id="daily-quote"></p>
                        <p class="text-xs mt-1" style="color: var(--text-tertiary);" id="quote-attribution"></p>
                    </div>
                    <!-- Plan usage pill -->
                    <div class="hidden md:block text-right flex-shrink-0 ml-4">
                        <a href="/settings" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold no-underline transition-all" style="background: var(--brand-bg); color: var(--brand);" onmouseover="this.style.background='var(--brand)'; this.style.color='white'" onmouseout="this.style.background='var(--brand-bg)'; this.style.color='var(--brand)'">
                            {{ usage.plan_name }}
                            {% if usage.is_free and usage.trial_days_left is defined %}
                                &middot; {{ usage.trial_days_left }}d left
                            {% endif %}
                            &middot; {{ usage.orders_used }}/{{ usage.orders_limit }} orders
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-3 mb-6 animate-in delay-1">
                <a href="/products/add" class="quick-action btn-primary">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                    Add Product
                </a>
                <button onclick="document.getElementById('create-order-panel').classList.toggle('hidden')" class="quick-action btn-secondary">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                    Create Order
                </button>
                {% if seller.etsy_access_token %}
                <form method="POST" action="/etsy/check-orders" class="inline">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="quick-action btn-secondary">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>
                        Check Etsy Orders
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Create Order Panel (hidden by default) -->
            {% if products %}
            <div id="create-order-panel" class="card mb-6 hidden animate-in">
                <div class="px-5 py-4 border-b relative" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center" style="color: var(--text-primary);">Create Order</h2>
                    <button onclick="document.getElementById('create-order-panel').classList.add('hidden')" class="p-1 rounded-lg absolute right-5 top-1/2 -translate-y-1/2" style="color: var(--text-tertiary);">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-5">
                    <form method="POST" action="/orders/create" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider mb-1.5" style="color: var(--text-tertiary);">Product</label>
                            <select name="product_id" required class="w-full px-3 py-2.5 rounded-lg text-sm transition-all" style="background: var(--surface-2); border: 1px solid var(--border-default); color: var(--text-primary);">
                                {% for p in products %}
                                <option value="{{ p.id }}">{{ p.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider mb-1.5" style="color: var(--text-tertiary);">Buyer Name</label>
                            <input type="text" name="buyer_name" placeholder="John Doe" class="w-full px-3 py-2.5 rounded-lg text-sm transition-all" style="background: var(--surface-2); border: 1px solid var(--border-default);">
                        </div>
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider mb-1.5" style="color: var(--text-tertiary);">Buyer Email</label>
                            <input type="email" name="buyer_email" placeholder="buyer@email.com" class="w-full px-3 py-2.5 rounded-lg text-sm transition-all" style="background: var(--surface-2); border: 1px solid var(--border-default);">
                        </div>
                        <div>
                            <button type="submit" class="btn-primary w-full py-2.5 rounded-lg text-sm">Create & Get Link</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 animate-in delay-2">
                <div class="card card-hover relative overflow-hidden p-5">
                    <div class="stat-accent" style="background: linear-gradient(180deg, #4a6741, #5c7d52);"></div>
                    <div class="pl-2">
                        <div class="text-xs font-medium uppercase tracking-wider mb-1" style="color: var(--text-tertiary);">Total Orders</div>
                        <div class="text-3xl font-bold font-mono tabular-nums" style="color: var(--text-primary);">{{ stats.total_orders }}</div>
                    </div>
                </div>
                <div class="card card-hover relative overflow-hidden p-5">
                    <div class="stat-accent" style="background: linear-gradient(180deg, #7a8c6e, #8fa382);"></div>
                    <div class="pl-2">
                        <div class="text-xs font-medium uppercase tracking-wider mb-1" style="color: var(--text-tertiary);">Completed</div>
                        <div class="text-3xl font-bold font-mono tabular-nums" style="color: #7a8c6e;">{{ stats.complete }}</div>
                    </div>
                </div>
                <div class="card card-hover relative overflow-hidden p-5">
                    <div class="stat-accent" style="background: linear-gradient(180deg, #d97706, #f59e0b);"></div>
                    <div class="pl-2">
                        <div class="text-xs font-medium uppercase tracking-wider mb-1" style="color: var(--text-tertiary);">Awaiting Buyer</div>
                        <div class="text-3xl font-bold font-mono tabular-nums" style="color: #d97706;">{{ stats.awaiting_buyer }}</div>
                    </div>
                </div>
            </div>

            <!-- Etsy Integration -->
            <div id="etsy" class="card mb-6 animate-in delay-3">
                <div class="px-5 py-4 border-b relative" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center flex items-center justify-center gap-2" style="color: var(--text-primary);">
                        <svg class="w-5 h-5" style="color: #d97706;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>
                        Etsy Integration
                    </h2>
                    <div class="absolute right-5 top-1/2 -translate-y-1/2">
                    {% if seller.etsy_access_token %}
                    <span class="badge badge-success">
                        <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                        Connected
                    </span>
                    {% else %}
                    <span class="badge badge-neutral">Not connected</span>
                    {% endif %}
                    </div>
                </div>
                <div class="p-5">
                    {% if seller.etsy_access_token %}
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="flex-1">
                            <p class="text-sm font-medium" style="color: var(--text-primary);">Shop ID: <span class="font-mono text-xs" style="color: var(--text-secondary);">{{ seller.etsy_shop_id }}</span></p>
                            <p class="text-xs mt-1" style="color: var(--text-tertiary);">Connected {{ seller.etsy_connected_at[:10] if seller.etsy_connected_at else 'recently' }}</p>
                            {% if seller.etsy_last_order_check %}
                            <p class="text-xs mt-0.5" style="color: var(--text-tertiary);">Last check: {{ seller.etsy_last_order_check[:16] }}</p>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <form method="POST" action="/etsy/import-products" class="inline">
                                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn-primary text-xs py-2 px-4">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
                                    Import Products
                                </button>
                            </form>
                            <form method="POST" action="/auth/etsy/disconnect" class="inline">
                                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn-secondary text-xs py-2 px-4" style="color: var(--text-tertiary);">Disconnect</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <svg class="w-12 h-12 mx-auto mb-3" style="color: #d97706; opacity: 0.6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>
                        <p class="text-sm mb-1 font-medium" style="color: var(--text-primary);">Connect your Etsy shop</p>
                        <p class="text-xs mb-4" style="color: var(--text-tertiary);">Import products and auto-create orders when buyers purchase on Etsy.</p>
                        <a href="/auth/etsy" class="btn-primary px-6 py-2.5 rounded-xl text-sm no-underline inline-flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>
                            Connect Etsy
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Products -->
            <div class="card mb-6 animate-in delay-4">
                <div class="px-5 py-4 border-b relative" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center" style="color: var(--text-primary);">Products</h2>
                    <a href="/products/add" class="btn-primary text-xs py-2 px-4 no-underline absolute right-5 top-1/2 -translate-y-1/2">+ Add Product</a>
                </div>
                <div class="p-1">
                    {% if products %}
                    <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr><th>Product</th><th>Questions</th><th class="hidden lg:table-cell">Category</th><th></th></tr>
                        </thead>
                        <tbody>
                            {% for p in products %}
                            <tr class="cursor-pointer" onclick="window.location='/products/{{ p.id }}'" tabindex="0" role="link" onkeydown="if(event.key==='Enter')window.location='/products/{{ p.id }}'">
                                <td>
                                    <div class="flex items-center gap-3">
                                        {% if p.image_url %}
                                        <img src="{{ p.image_url }}" class="product-thumb" alt="">
                                        {% else %}
                                        <div class="product-initial">{{ p.title[0] }}</div>
                                        {% endif %}
                                        <span class="font-medium truncate block max-w-[200px]" style="color: var(--brand);">{{ p.title }}</span>
                                    </div>
                                </td>
                                <td><span class="badge badge-brand">{{ p.intake_questions|length }} questions</span></td>
                                <td class="hidden lg:table-cell" style="color: var(--text-secondary);">{{ p.category or '—' }}</td>
                                <td class="text-right"><a href="/products/{{ p.id }}" class="btn-secondary text-xs py-2 px-3 no-underline">View</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <!-- Gift box illustration -->
                        <svg class="w-16 h-16 mx-auto mb-4" viewBox="0 0 64 64" fill="none">
                            <rect x="8" y="28" width="48" height="28" rx="4" stroke="#4a6741" stroke-width="2" fill="rgba(74,103,65,0.06)"/>
                            <rect x="4" y="20" width="56" height="12" rx="3" stroke="#4a6741" stroke-width="2" fill="rgba(74,103,65,0.1)"/>
                            <line x1="32" y1="20" x2="32" y2="56" stroke="#4a6741" stroke-width="2"/>
                            <path d="M32 20C32 20 24 8 18 12C12 16 22 20 32 20Z" stroke="#5c7d52" stroke-width="2" fill="rgba(92,125,82,0.1)"/>
                            <path d="M32 20C32 20 40 8 46 12C52 16 42 20 32 20Z" stroke="#5c7d52" stroke-width="2" fill="rgba(92,125,82,0.1)"/>
                        </svg>
                        <p class="text-sm font-medium mb-1" style="color: var(--text-primary);">Your shop is empty!</p>
                        <p class="text-sm mb-4" style="color: var(--text-tertiary);">Let's add your first product. It only takes a minute.</p>
                        <a href="/products/add" class="btn-primary text-sm px-5 py-2.5 no-underline">Add Your First Product</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Orders -->
            <div class="card mb-6 animate-in delay-5">
                <div class="px-5 py-4 border-b" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center" style="color: var(--text-primary);">Orders</h2>
                </div>
                <div class="px-5 py-3 border-b flex flex-col sm:flex-row items-start sm:items-center gap-3" style="border-color: var(--border-subtle);">
                    <input type="text" id="order-search" placeholder="Search orders..." oninput="filterOrders()" class="flex-1 px-3 py-2 rounded-lg text-sm" style="background: var(--surface-2); border: 1px solid var(--border-default); color: var(--text-primary); min-width: 180px;">
                    <div class="flex gap-1.5">
                        <button class="filter-pill active" onclick="setFilter('all')">All</button>
                        <button class="filter-pill" onclick="setFilter('awaiting')">Awaiting</button>
                        <button class="filter-pill" onclick="setFilter('complete')">Complete</button>
                    </div>
                </div>
                <div class="p-1">
                    {% if orders %}
                    <div class="overflow-x-auto">
                    <table id="orders-table">
                        <thead>
                            <tr><th>Order</th><th>Product</th><th class="hidden lg:table-cell">Buyer</th><th>Status</th><th class="hidden lg:table-cell">Fulfillment</th><th>Intake Link</th><th></th></tr>
                        </thead>
                        <tbody>
                            {% for o in orders %}
                            <tr data-complete="{{ '1' if o.specs_complete else '0' }}" data-search="{{ (o.id ~ ' ' ~ (o.product_title|default('')) ~ ' ' ~ (o.buyer_name|default('')) ~ ' ' ~ (o.buyer_email|default('')))|lower }}">
                                <td><span class="font-mono text-xs" style="color: var(--text-tertiary);">#{{ o.id[:6] }}</span></td>
                                <td class="font-medium">{{ o.product_title }}</td>
                                <td class="hidden lg:table-cell" style="color: var(--text-secondary);">{{ o.buyer_name or o.buyer_email or '—' }}</td>
                                <td>
                                    {% if o.specs_complete %}
                                    <span class="badge badge-success"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Complete</span>
                                    {% elif o.status == 'collecting' %}
                                    <span class="badge badge-warning"><span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></span> Awaiting Buyer</span>
                                    {% else %}
                                    <span class="badge badge-neutral">Pending</span>
                                    {% endif %}
                                    {% if o.escalated %}
                                    <span class="badge badge-danger">Escalated</span>
                                    {% endif %}
                                    {% if o.id in stale_order_ids %}
                                    <span class="badge badge-stale" title="Order inactive for 3+ days">Needs follow-up</span>
                                    {% endif %}
                                </td>
                                <td class="hidden lg:table-cell">
                                    {% if o.fulfillment_status == 'delivered' %}
                                    <span class="badge badge-success">Delivered</span>
                                    {% elif o.fulfillment_status == 'shipped' %}
                                    <span class="badge badge-brand">Shipped</span>
                                    {% elif o.fulfillment_status == 'in_progress' %}
                                    <span class="badge badge-warning">In Progress</span>
                                    {% else %}
                                    <span class="badge badge-neutral">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button onclick="copyLink('/intake/{{ o.id }}')" class="inline-flex items-center gap-1.5 font-mono text-xs px-2.5 py-2 rounded-lg cursor-pointer transition-all" style="background: var(--surface-2); color: var(--text-tertiary); border: none;" title="Copy intake link">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                        /intake/{{ o.id[:8] }}...
                                    </button>
                                </td>
                                <td class="text-right"><a href="/orders/{{ o.id }}" class="btn-secondary text-xs py-2 px-3 no-underline">View</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <!-- Mailbox illustration -->
                        <svg class="w-16 h-16 mx-auto mb-4" viewBox="0 0 64 64" fill="none">
                            <rect x="12" y="24" width="40" height="28" rx="4" stroke="#4a6741" stroke-width="2" fill="rgba(74,103,65,0.06)"/>
                            <path d="M12 28L32 40L52 28" stroke="#4a6741" stroke-width="2" fill="none"/>
                            <rect x="26" y="14" width="12" height="12" rx="2" stroke="#5c7d52" stroke-width="2" fill="rgba(92,125,82,0.1)"/>
                            <line x1="32" y1="18" x2="32" y2="22" stroke="#5c7d52" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p class="text-sm font-medium mb-1" style="color: var(--text-primary);">No orders yet</p>
                        <p class="text-sm" style="color: var(--text-tertiary);">Once you add a product, you can create intake links for your buyers.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Completed Specs -->
            {% if completed_orders %}
            <div class="card mb-6 animate-in delay-6">
                <div class="px-5 py-4 border-b" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center" style="color: var(--text-primary);">Completed Specs</h2>
                </div>
                <div class="p-5 space-y-3">
                    {% for co in completed_orders %}
                    <div class="rounded-xl border overflow-hidden" style="border-color: var(--border-default);">
                        <button onclick="toggleSpecCard(this)" class="w-full flex items-center justify-between px-4 py-3 text-left transition-colors" style="background: var(--surface-0);" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='var(--surface-0)'">
                            <div class="flex items-center gap-3 min-w-0">
                                <span class="badge badge-success shrink-0">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                </span>
                                <div class="min-w-0">
                                    <span class="text-sm font-medium truncate block" style="color: var(--text-primary);">{{ co.product_title }}</span>
                                    <span class="text-xs" style="color: var(--text-tertiary);">{{ co.buyer_name or 'Unknown' }} · {{ co.completed_at[:10] if co.completed_at else '' }}</span>
                                </div>
                            </div>
                            <svg class="w-4 h-4 shrink-0 transition-transform spec-chevron" style="color: var(--text-tertiary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="spec-card-body hidden border-t px-4 py-3" style="border-color: var(--border-subtle); background: var(--surface-1);"
                             data-specs="{{ co.customer_specs|tojson|e }}" data-product="{{ co.product_title }}" data-buyer="{{ co.buyer_name or 'Unknown' }}" data-questions="{{ co.intake_questions|tojson|e }}">
                            {% for q in co.intake_questions %}
                            {% set val = co.customer_specs.get(q.field_name, '') %}
                            {% if val %}
                            <div class="flex justify-between py-1.5 text-sm" style="border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-tertiary);">{{ q.question }}</span>
                                <span class="font-medium ml-4 text-right" style="color: var(--text-primary);">{{ val }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                            <div class="flex gap-2 mt-3">
                                <button onclick="copySpecCard(this)" class="btn-secondary text-xs py-2 px-3">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                    Copy
                                </button>
                                <a href="/orders/{{ co.id }}" class="btn-secondary text-xs py-2 px-3 no-underline">View Order</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Activity Feed -->
            {% if activity %}
            <div class="card animate-in delay-7">
                <div class="px-5 py-4 border-b" style="border-color: var(--border-subtle);">
                    <h2 class="text-base font-semibold text-center" style="color: var(--text-primary);">Recent Activity</h2>
                </div>
                <div class="p-5">
                    <div class="space-y-4">
                        {% for event in activity %}
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center">
                                <div class="activity-dot" style="background: {{ '#7a8c6e' if event.type == 'order_complete' else '#4a6741' }};"></div>
                                {% if not loop.last %}
                                <div class="activity-line"></div>
                                {% endif %}
                            </div>
                            <div class="pb-1 -mt-0.5">
                                <p class="text-sm" style="color: var(--text-primary);">{{ event.description }}</p>
                                <p class="text-xs" style="color: var(--text-tertiary);">{{ event.timestamp[:16] if event.timestamp else '' }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    // Order search & filter
    let currentFilter = 'all';
    function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        filterOrders();
    }
    function filterOrders() {
        const search = (document.getElementById('order-search')?.value || '').toLowerCase();
        document.querySelectorAll('#orders-table tbody tr').forEach(tr => {
            const searchData = tr.getAttribute('data-search') || '';
            const isComplete = tr.getAttribute('data-complete') === '1';
            const matchesSearch = !search || searchData.includes(search);
            const matchesFilter = currentFilter === 'all' ||
                (currentFilter === 'complete' && isComplete) ||
                (currentFilter === 'awaiting' && !isComplete);
            tr.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
        });
    }

    // Completed specs cards
    function toggleSpecCard(btn) {
        const body = btn.nextElementSibling;
        const chevron = btn.querySelector('.spec-chevron');
        body.classList.toggle('hidden');
        chevron.classList.toggle('open');
    }
    function copySpecCard(btn) {
        const card = btn.closest('.spec-card-body');
        const specs = JSON.parse(card.dataset.specs);
        const questions = JSON.parse(card.dataset.questions);
        const product = card.dataset.product;
        const buyer = card.dataset.buyer;
        let text = 'Product: ' + product + '\nBuyer: ' + buyer + '\n\n';
        questions.forEach(q => {
            const val = specs[q.field_name];
            if (val) text += q.question + ': ' + val + '\n';
        });
        navigator.clipboard.writeText(text.trim()).then(() => showToast('Specs copied!', 'success'));
    }

    // Daily quotes
    const quotes = [
        {text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney", source: ""},
        {text: "Your most unhappy customers are your greatest source of learning.", author: "Bill Gates", source: ""},
        {text: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs", source: ""},
        {text: "If you do build a great experience, customers tell each other about that.", author: "Jeff Bezos", source: ""},
        {text: "Done is better than perfect.", author: "Sheryl Sandberg", source: "Lean In"},
        {text: "The biggest risk is not taking any risk.", author: "Mark Zuckerberg", source: ""},
        {text: "Chase the vision, not the money; the money will end up following you.", author: "Tony Hsieh", source: ""},
        {text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill", source: ""},
        {text: "Your work is going to fill a large part of your life. The only way to do great work is to love what you do.", author: "Steve Jobs", source: ""},
        {text: "The secret of getting ahead is getting started.", author: "Mark Twain", source: ""},
        {text: "Every great dream begins with a dreamer.", author: "Harriet Tubman", source: ""},
        {text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller", source: ""},
        {text: "I knew that if I failed I wouldn't regret that, but the one thing I might regret is not trying.", author: "Jeff Bezos", source: ""},
        {text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb", source: ""},
        {text: "Make every detail perfect and limit the number of details to perfect.", author: "Jack Dorsey", source: ""},
        {text: "Quality is not an act, it is a habit.", author: "Aristotle", source: ""},
        {text: "The only way to do great work is to love what you do.", author: "Steve Jobs", source: ""},
        {text: "It always seems impossible until it's done.", author: "Nelson Mandela", source: ""},
        {text: "A brand for a company is like a reputation for a person.", author: "Jeff Bezos", source: ""},
        {text: "In the middle of difficulty lies opportunity.", author: "Albert Einstein", source: ""},
        {text: "If people like you, they'll listen to you, but if they trust you, they'll do business with you.", author: "Zig Ziglar", source: ""},
        {text: "The best customer service is if the customer doesn't need to call you, doesn't need to talk to you. It just works.", author: "Jeff Bezos", source: ""},
        {text: "Do what you do so well that they will want to see it again and bring their friends.", author: "Walt Disney", source: ""},
        {text: "Entrepreneurship is living a few years of your life like most people won't, so you can spend the rest like most people can't.", author: "Warren Tracy", source: ""},
    ];
    const dayIndex = Math.floor(Date.now() / 86400000) % quotes.length;
    const q = quotes[dayIndex];
    document.getElementById('daily-quote').textContent = '"' + q.text + '"';
    document.getElementById('quote-attribution').textContent = q.author ? ('— ' + q.author + (q.source ? ', ' + q.source : '')) : ('— ' + q.source);

    // Time-of-day greeting
    const hour = new Date().getHours();
    const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('greeting').textContent = greeting + ', {{ seller.display_name or seller.shop_name }}!';
{% endblock %}
