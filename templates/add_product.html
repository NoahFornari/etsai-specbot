{% extends "_base.html" %}

{% block title %}Add Product â€” ETSAI{% endblock %}

{% block extra_styles %}
    .tab-pills {
        display: flex; gap: 4px; padding: 4px;
        background: var(--surface-2); border-radius: 14px;
    }
    .tab-pill {
        padding: 0.5rem 1rem; font-size: 0.8125rem; font-weight: 600;
        border-radius: 10px; cursor: pointer; transition: all 0.2s;
        border: none; color: var(--text-secondary); background: transparent;
        display: inline-flex; align-items: center; gap: 0.375rem;
    }
    .tab-pill:hover { color: var(--text-primary); }
    .tab-pill.active {
        color: white; background: linear-gradient(135deg, #4a6741, #5c7d52);
        box-shadow: 0 2px 8px rgba(74,103,65,0.25);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .listing-card {
        border: 1px solid var(--border-default); border-radius: 12px;
        padding: 0.75rem; transition: all 0.2s; cursor: pointer;
        background: var(--surface-0);
    }
    .listing-card:hover { border-color: var(--brand); box-shadow: 0 2px 8px rgba(74,103,65,0.1); }
    .listing-card.selected { border-color: var(--brand); background: var(--brand-bg); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .form-field label {
        display: block; font-size: 0.875rem; font-weight: 500;
        margin-bottom: 0.375rem; color: var(--text-primary);
    }
    .form-field .hint {
        font-size: 0.75rem; color: var(--text-tertiary);
        margin-bottom: 0.5rem;
    }
    .form-field input, .form-field textarea {
        width: 100%; padding: 0.75rem 1rem; border-radius: 12px;
        font-size: 0.875rem; transition: all 0.2s;
        background: var(--surface-2); border: 1px solid var(--border-default);
        color: var(--text-primary); font-family: 'Inter', system-ui, sans-serif;
    }
    .form-field textarea { resize: vertical; }
    .loading-phase {
        display: none; text-align: center; padding: 3rem 1rem;
    }
    .loading-phase.active { display: block; }
    .loading-dots {
        display: inline-flex; gap: 4px;
    }
    .loading-dots span {
        width: 8px; height: 8px; border-radius: 50%;
        background: var(--brand); animation: bounceDot 1.4s infinite ease-in-out;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.32s; }
    @keyframes bounceDot {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
        40% { transform: scale(1); opacity: 1; }
    }
{% endblock %}

{% block body %}
    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="p-5 pb-3">
            <a href="/dashboard" class="flex items-center gap-1.5 text-xl font-extrabold tracking-tight no-underline" style="color: var(--text-primary);"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none"><ellipse cx="12" cy="22" rx="9" ry="5" transform="rotate(-25 12 22)" fill="#5c7d52"/><ellipse cx="20" cy="27" rx="10" ry="7" fill="#4a6741"/><ellipse cx="23" cy="29" rx="7" ry="5" fill="#f4845f"/><circle cx="27" cy="15" r="9" fill="#4a6741"/><path d="M35 13L48 11.5L35 16.5Z" fill="#d4846a"/><circle cx="31" cy="13" r="3" fill="white"/><circle cx="32" cy="13" r="1.8" fill="#2c1810"/><circle cx="32.5" cy="12" r="0.7" fill="white"/><path d="M8 31L3 38L7 34L4 41L9 33" fill="#3d5a37"/></svg><span>ETS<span class="gradient-text">AI</span></span></a>
        </div>
        <nav class="flex-1 py-2">
            <a href="/dashboard" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"/></svg>
                Dashboard
            </a>
            <a href="/products/add" class="sidebar-nav-item active">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Products
            </a>
            {% if seller.is_admin %}
            <a href="/growth" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941"/></svg>
                Growth
            </a>
            {% endif %}
            <a href="/settings" class="sidebar-nav-item">
                <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Settings
            </a>
        </nav>
        <div class="p-4 border-t" style="border-color: var(--border-default);">
            <button onclick="toggleDarkMode()" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-colors" style="color: var(--text-tertiary); background: transparent;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
                <svg class="w-4 h-4 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <svg class="w-4 h-4 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                <span class="hidden dark:inline">Light mode</span>
                <span class="inline dark:hidden">Dark mode</span>
            </button>
        </div>
    </aside>

    <div class="main-content">
        <!-- Mobile header -->
        <div class="md:hidden flex items-center justify-between px-4 py-3 border-b" style="background: var(--surface-0); border-color: var(--border-default);">
            <button onclick="toggleSidebar()" class="p-2 rounded-lg" style="color: var(--text-secondary);">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
            </button>
            <span class="flex items-center gap-1 text-sm font-bold"><svg class="w-4 h-4" viewBox="0 0 48 48" fill="none"><ellipse cx="12" cy="22" rx="9" ry="5" transform="rotate(-25 12 22)" fill="#5c7d52"/><ellipse cx="20" cy="27" rx="10" ry="7" fill="#4a6741"/><ellipse cx="23" cy="29" rx="7" ry="5" fill="#f4845f"/><circle cx="27" cy="15" r="9" fill="#4a6741"/><path d="M35 13L48 11.5L35 16.5Z" fill="#d4846a"/><circle cx="31" cy="13" r="3" fill="white"/><circle cx="32" cy="13" r="1.8" fill="#2c1810"/><circle cx="32.5" cy="12" r="0.7" fill="white"/><path d="M8 31L3 38L7 34L4 41L9 33" fill="#3d5a37"/></svg><span>ETS<span class="gradient-text">AI</span></span></span>
            <div class="w-9"></div>
        </div>

        <div class="max-w-2xl mx-auto px-5 py-10">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
            <div class="flash {{ category }} px-4 py-3 mb-5">{{ message }}</div>
            {% endfor %}
            {% endwith %}

            <div class="animate-in">
                <div class="mb-6">
                    <h1 class="text-2xl font-display mb-1" style="color: var(--text-primary);">Add a Product</h1>
                    <p class="text-sm" style="color: var(--text-tertiary);">What magic do you create? Our AI will generate the perfect intake questions.</p>
                </div>

                <!-- Pill Tabs -->
                <div class="tab-pills mb-6">
                    <button class="tab-pill active" onclick="switchTab('manual')" id="tab-manual">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Manual
                    </button>
                    <button class="tab-pill" onclick="switchTab('url')" id="tab-url">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                        Import URL
                    </button>
                    <button class="tab-pill" onclick="switchTab('shop')" id="tab-shop">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        Import Shop
                    </button>
                </div>

                <div class="card overflow-hidden">
                    <!-- Tab 1: Manual -->
                    <div class="tab-content active p-6" id="content-manual">
                        <form method="POST" action="/products/add" class="space-y-5" id="manual-form">
                            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="ai_generate" value="1">

                            <div class="form-field">
                                <label>Product Title <span style="color: var(--brand);">*</span></label>
                                <p class="hint">What do you make? Be specific for better AI questions.</p>
                                <input type="text" name="title" required placeholder="e.g. Custom Engraved Sterling Silver Ring">
                            </div>

                            <div class="form-field">
                                <label>Category</label>
                                <input type="text" name="category" placeholder="Jewelry, Apparel, Home Decor, etc.">
                            </div>

                            <div class="form-field">
                                <label>Description</label>
                                <p class="hint">Help the AI understand what buyers can customize</p>
                                <textarea name="description" rows="3" placeholder="Brief description of the product and customization options..."></textarea>
                            </div>

                            <div class="form-field">
                                <label>Price</label>
                                <input type="number" name="price" step="0.01" placeholder="59.99">
                            </div>

                            <div class="form-field">
                                <label>Notes for AI</label>
                                <p class="hint">What should the AI know about your capabilities? This helps it answer buyer questions accurately.</p>
                                <textarea name="seller_notes" rows="3" placeholder="e.g. We can do custom fonts but not images. Gold and silver only. Turnaround is 3-5 days.">{{ default_notes or '' }}</textarea>
                            </div>

                            <button type="submit" class="btn-primary w-full justify-center py-3">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Add Product & Generate Questions
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.2);">AI</span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab 2: Import from URL -->
                    <div class="tab-content p-6" id="content-url">
                        <form method="POST" action="/products/import-url" class="space-y-5">
                            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                            <div class="form-field">
                                <label>Etsy Listing URL <span style="color: var(--brand);">*</span></label>
                                <p class="hint">Paste the URL of any Etsy listing to import it automatically</p>
                                <input type="url" name="url" required placeholder="https://www.etsy.com/listing/1234567890/custom-engraved-ring">
                            </div>

                            <div class="form-field">
                                <label>Notes for AI</label>
                                <p class="hint">Anything the AI should know about your capabilities?</p>
                                <textarea name="seller_notes" rows="3" placeholder="e.g. We can do custom fonts but not images. Gold and silver only. Turnaround is 3-5 days."></textarea>
                            </div>

                            <button type="submit" class="btn-primary w-full justify-center py-3">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Import & Generate Questions
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.2);">AI</span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab 3: Import Shop -->
                    <div class="tab-content p-6" id="content-shop">
                        <div class="space-y-5">
                            <div class="form-field">
                                <label>Etsy Shop URL <span style="color: var(--brand);">*</span></label>
                                <p class="hint">Paste your Etsy shop URL to browse all your listings</p>
                                <div class="flex gap-2">
                                    <input type="url" id="shop-url-input" placeholder="https://www.etsy.com/shop/YourShopName" class="flex-1">
                                    <button onclick="fetchShopListings()" id="fetch-shop-btn" class="btn-primary whitespace-nowrap">
                                        <svg class="w-4 h-4" id="fetch-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        <svg class="w-4 h-4 spinner hidden" id="fetch-spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        Fetch
                                    </button>
                                </div>
                            </div>

                            <div class="form-field">
                                <label>Notes for AI</label>
                                <p class="hint">These notes will be applied to all imported products</p>
                                <textarea id="shop-seller-notes" rows="3" placeholder="e.g. We can do custom fonts but not images. Gold and silver only."></textarea>
                            </div>

                            <!-- Listings grid (populated by JS) -->
                            <div id="shop-listings" class="hidden">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm font-medium" style="color: var(--text-primary);">
                                        <span id="listings-count">0</span> listings found
                                    </p>
                                    <button onclick="toggleSelectAll()" class="text-xs font-semibold px-3 py-1.5 rounded-lg transition-colors" style="color: var(--brand); background: var(--brand-bg);">
                                        Select All
                                    </button>
                                </div>
                                <div id="listings-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-1"></div>

                                <div class="pt-4">
                                    <button onclick="importSelected()" id="import-shop-btn" class="btn-primary w-full justify-center py-3">
                                        <svg class="w-4 h-4" id="import-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        <svg class="w-4 h-4 spinner hidden" id="import-spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        Import Selected (<span id="selected-count">0</span>)
                                        <span class="text-xs font-bold px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.2);">AI</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Error/status messages -->
                            <div id="shop-status" class="hidden text-sm px-4 py-3 rounded-xl"></div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="/dashboard" class="text-sm no-underline transition-colors" style="color: var(--text-tertiary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-tertiary)'">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    // Tab switching
    function switchTab(tab) {
        document.querySelectorAll('.tab-pill').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('content-' + tab).classList.add('active');
    }

    // Shop import state
    let shopListings = [];

    async function fetchShopListings() {
        const url = document.getElementById('shop-url-input').value.trim();
        if (!url) { showShopStatus('Please paste a shop URL.', true); return; }

        const btn = document.getElementById('fetch-shop-btn');
        const icon = document.getElementById('fetch-icon');
        const spinner = document.getElementById('fetch-spinner');
        btn.disabled = true;
        icon.classList.add('hidden');
        spinner.classList.remove('hidden');
        showShopStatus('', false);

        try {
            const resp = await fetch('/products/import-shop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
                body: JSON.stringify({ shop_url: url })
            });
            const data = await resp.json();

            if (!resp.ok) {
                showShopStatus(data.error || 'Failed to fetch listings.', true);
                return;
            }

            shopListings = data.listings;
            renderListings();
            document.getElementById('shop-listings').classList.remove('hidden');
            document.getElementById('listings-count').textContent = data.count;
        } catch (e) {
            showShopStatus('Network error. Please try again.', true);
        } finally {
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
    }

    function renderListings() {
        const grid = document.getElementById('listings-grid');
        grid.innerHTML = shopListings.map((l, i) => `
            <div class="listing-card flex gap-3 items-start" onclick="toggleListing(${i})" id="listing-${i}">
                <input type="checkbox" class="listing-cb mt-1" style="accent-color: var(--brand);" data-index="${i}" onclick="event.stopPropagation(); toggleListing(${i})">
                ${l.thumbnail ? `<img src="${l.thumbnail}" class="w-14 h-14 rounded-lg object-cover flex-shrink-0" alt="">` : `<div class="w-14 h-14 rounded-lg flex-shrink-0 flex items-center justify-center" style="background: var(--surface-2);"><svg class="w-6 h-6" style="color: var(--text-tertiary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>`}
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium truncate" style="color: var(--text-primary);">${escapeHtml(l.title)}</p>
                    ${l.price ? `<p class="text-xs mt-0.5" style="color: var(--text-secondary);">${escapeHtml(l.price)}</p>` : ''}
                </div>
            </div>
        `).join('');
        updateSelectedCount();
    }

    function toggleListing(index) {
        const card = document.getElementById('listing-' + index);
        const cb = card.querySelector('.listing-cb');
        cb.checked = !cb.checked;
        card.classList.toggle('selected', cb.checked);
        updateSelectedCount();
    }

    function toggleSelectAll() {
        const cbs = document.querySelectorAll('.listing-cb');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach((cb, i) => {
            cb.checked = !allChecked;
            document.getElementById('listing-' + i).classList.toggle('selected', !allChecked);
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.listing-cb:checked').length;
        document.getElementById('selected-count').textContent = count;
    }

    async function importSelected() {
        const cbs = document.querySelectorAll('.listing-cb:checked');
        const urls = Array.from(cbs).map(cb => shopListings[cb.dataset.index].url);
        const sellerNotes = document.getElementById('shop-seller-notes').value.trim();

        if (urls.length === 0) { showShopStatus('Select at least one listing to import.', true); return; }

        const btn = document.getElementById('import-shop-btn');
        const icon = document.getElementById('import-icon');
        const spinner = document.getElementById('import-spinner');
        btn.disabled = true;
        icon.classList.add('hidden');
        spinner.classList.remove('hidden');
        showShopStatus('Importing ' + urls.length + ' listings... This may take a moment as AI generates questions for each product.', false);

        try {
            const resp = await fetch('/products/import-shop/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
                body: JSON.stringify({ urls: urls, seller_notes: sellerNotes })
            });
            const data = await resp.json();

            if (data.imported && data.imported.length > 0) {
                showShopStatus(`Successfully imported ${data.count} products!` +
                    (data.errors.length > 0 ? ` (${data.errors.length} failed)` : ''), false);
                setTimeout(() => { window.location.href = '/dashboard'; }, 1500);
            } else {
                showShopStatus('Import failed: ' + (data.error || 'Unknown error'), true);
            }
        } catch (e) {
            showShopStatus('Network error. Please try again.', true);
        } finally {
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
    }

    function showShopStatus(msg, isError) {
        const el = document.getElementById('shop-status');
        if (!msg) { el.classList.add('hidden'); return; }
        el.classList.remove('hidden');
        el.textContent = msg;
        el.style.background = isError ? 'rgba(220,38,38,0.08)' : 'var(--sage-bg)';
        el.style.color = isError ? '#dc2626' : 'var(--sage)';
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Prevent double-submit on manual form
    document.getElementById('manual-form')?.addEventListener('submit', function() {
        const btn = this.querySelector('[type="submit"]');
        if (btn.disabled) { event.preventDefault(); return; }
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Generating Questions...';
    });
{% endblock %}
